import{d as k,w as F}from"./index-779a6bb2.js";import{E as L,o as W,w as M,a as T,q as m,g as R}from"./user-a6a30b9f.js";import{A as U,a1 as O}from"./index-169c4bf0.js";function ze(){return Math.random().toString(36).substring(2)}function v(e){return e.trim().replace(/\s+/g,"-").replace(/[^a-z0-9-_]/gi,"").toLowerCase()}function pe(e){U().then(()=>e.focus())}const G=(e,t)=>t.some(n=>e instanceof n);let g,A;function K(){return g||(g=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function X(){return A||(A=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const j=new WeakMap,I=new WeakMap,N=new WeakMap,h=new WeakMap,Q=new WeakMap;function $(e){const t=new Promise((n,i)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",a)},o=()=>{n(l(e.result)),r()},a=()=>{i(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",a)});return t.then(n=>{n instanceof IDBCursor&&j.set(n,e)}).catch(()=>{}),Q.set(t,e),t}function H(e){if(I.has(e))return;const t=new Promise((n,i)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",a),e.removeEventListener("abort",a)},o=()=>{n(),r()},a=()=>{i(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",a),e.addEventListener("abort",a)});I.set(e,t)}let b={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return I.get(e);if(t==="objectStoreNames")return e.objectStoreNames||N.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return l(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function J(e){b=e(b)}function Y(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const i=e.call(y(this),t,...n);return N.set(i,t.sort?t.sort():[t]),l(i)}:X().includes(e)?function(...t){return e.apply(y(this),t),l(j.get(this))}:function(...t){return l(e.apply(y(this),t))}}function Z(e){return typeof e=="function"?Y(e):(e instanceof IDBTransaction&&H(e),G(e,K())?new Proxy(e,b):e)}function l(e){if(e instanceof IDBRequest)return $(e);if(h.has(e))return h.get(e);const t=Z(e);return t!==e&&(h.set(e,t),Q.set(t,e)),t}const y=e=>Q.get(e);function ee(e,t,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const a=indexedDB.open(e,t),d=l(a);return i&&a.addEventListener("upgradeneeded",u=>{i(l(a.result),u.oldVersion,u.newVersion,l(a.transaction),u)}),n&&a.addEventListener("blocked",u=>n(u.oldVersion,u.newVersion,u)),d.then(u=>{o&&u.addEventListener("close",()=>o()),r&&u.addEventListener("versionchange",s=>r(s.oldVersion,s.newVersion,s))}).catch(()=>{}),d}const te=["get","getKey","getAll","getAllKeys","count"],ne=["put","add","delete","clear"],_=new Map;function S(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(_.get(t))return _.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,r=ne.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||te.includes(n)))return;const o=async function(a,...d){const u=this.transaction(a,r?"readwrite":"readonly");let s=u.store;return i&&(s=s.index(d.shift())),(await Promise.all([s[n](...d),r&&u.done]))[0]};return _.set(t,o),o}J(e=>({...e,get:(t,n,i)=>S(t,n)||e.get(t,n,i),has:(t,n)=>!!S(t,n)||e.has(t,n)}));const ie="quantu",oe=1,se={upgrade(e,t,n){n===1&&(e.createObjectStore("quizzes",{keyPath:"local_id",autoIncrement:!0}).createIndex("user_id","user_id"),e.createObjectStore("questions",{keyPath:"local_id",autoIncrement:!0}).createIndex("user_id","user_id"))}};function p(){return re(ie,oe,se)}let w,D=!1;const q=new L;function re(e,t,n={}){return w?Promise.resolve(w):D?new Promise(i=>q.once("db",i)):(D=!0,ee(e,t,n).then(i=>(i.addEventListener("close",()=>{w=void 0}),w=i,q.emit("db",i),i)).finally(()=>{D=!1}))}async function ae(e){return await(await p()).getAllFromIndex("quizzes","user_id",e)}async function me(e){return await(await p()).get("quizzes",e)}async function x(e,t){const n=await p(),i={...B(e),...t,uri:v(t.name)},r=await n.put("quizzes",i);return{...i,local_id:r}}async function ce(e,t,n){const i=await p(),r=await i.get("quizzes",t)||B(e),o={...r,...n,user_id:e,local_id:t,uri:n.name?v(n.name):r.uri,updated_at:new Date};return await i.put("quizzes",o,t),o}async function ue(e,t,n){const i=await p(),o={...await i.get("quizzes",t)||B(e),...n,user_id:e,local_id:t};return await i.put("quizzes",o),o}async function P(e){await(await p()).delete("quizzes",e)}function B(e){return{id:0,local_deleted:0,user_id:e,name:"",uri:"",created_at:new Date,updated_at:new Date}}const z=F({}),we=k(z,e=>Object.values(e));async function he(e){var r;const t=(r=R())==null?void 0:r.id;let n={};T()&&(n=await m.postApiQuizzes({postApiQuizzes:e}));const i=await x(t,{...e,...n});return z.update(o=>({...o,[i.local_id]:i})),i}function ye(){return E?new Promise(e=>C.once("quizzes",e)):Promise.resolve(O(z))}const C=new L;let E=!1;async function V(e){E=!0;try{const t=await ae(e),n={},i={},r=[];for(const o of t)o.id===0?r.push(o):i[o.id]=o,o.local_deleted===0&&(n[o.local_id]=o);if(z.update(o=>({...o,...n})),T()){const o=await m.getApiQuizzes(),a={},d=new Set,u=[];for(const s of o){const c=i[s.id];c?c.updated_at>s.updated_at?c.local_deleted===1?u.push(m.deleteApiQuizzesId({id:s.id}).then(()=>P(c.local_id)).then(()=>{d.add(c.local_id)})):u.push(m.patchApiQuizzesId({id:s.id,patchApiQuizzesId:{...s,...c}}).then(f=>{a[c.id]={...c,...f}})):c.updated_at<s.updated_at?u.push(ce(e,c.local_id,{...c,...s}).then(f=>{a[f.local_id]=f})):a[c.local_id]={...c,...s}:u.push(x(e,s).then(f=>{a[f.local_id]=f}))}for(const s of r)u.push(m.postApiQuizzes({postApiQuizzes:s}).then(c=>ue(e,s.local_id,c)).then(c=>{a[c.local_id]=c}));await Promise.all(u),await Promise.all(Object.values(i).map(async s=>{a[s.local_id]||(d.add(s.local_id),await P(s.local_id))})),z.update(s=>{s={...s,...a};for(const c of d)delete s[c];return s})}}finally{E=!1,C.emit("quizzes",O(z))}}W.on("online",async()=>{const e=await M();V(e.id)});M().then(e=>V(e.id));export{pe as a,ze as b,he as c,v as d,ye as e,p as g,me as i,we as q};
