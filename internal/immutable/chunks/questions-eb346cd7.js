import{d as m,w as O}from"./index-3f2a2081.js";import{o as j,w as z,a as f,b as p,g as h}from"./user-226865bb.js";import{b as g}from"./IconBase-bfd10f6f.js";import{g as Q,a as U,i as A}from"./MdDelete-1a68d2e8.js";async function k(e){return await(await Q()).getAllFromIndex("questions","user_id",e)}async function B(e){return await(await Q()).get("questions",e)}async function v(e,i,t,o){const c=await Q(),s={...q(e,i,t),...o,uri:o.name?g(o.name):void 0},u=await c.put("questions",s);return{...s,local_id:u}}async function L(e,i,t,o,c){const s=await Q(),u=await s.get("questions",o)||q(e,i,t),n={...u,...c,user_id:e,local_learnable_resource:i,learnable_resource_id:t,local_id:o,uri:c.name?g(c.name):u.uri,updated_at:new Date};return await s.put("questions",n),n}async function x(e,i,t,o,c){const s=await Q(),n={...await s.get("questions",o)||q(e,i,t),...c,user_id:e,local_learnable_resource:i,learnable_resource_id:t,local_id:o};return await s.put("questions",n),n}async function F(e,i,t,o){const c=await Q(),u={...await c.get("questions",o)||q(e,i,t),user_id:e,local_learnable_resource:i,learnable_resource_id:t,local_id:o,updated_at:new Date,local_deleted:1};await c.put("questions",u)}async function y(e){await(await Q()).delete("questions",e)}function q(e,i,t){return{id:0,local_learnable_resource:i,local_deleted:0,learnable_resource_id:t,user_id:e,name:"",uri:"",created_at:new Date,updated_at:new Date}}const r=O({});m(r,e=>Object.values(e));const C=m(r,e=>e),M=m(r,e=>Object.values(e).reduce((i,t)=>((i[t.local_learnable_resource]||(i[t.local_learnable_resource]=[])).push(t),i),{}));async function R(e,i){var o;const t=await A(e);if(t){const c=(o=h())==null?void 0:o.id;let s={};f()&&(s=await p.postApiQuestions({quizId:t.id,postApiQuestions:i}));const u=await v(c,t.local_id,t.id,{...i,...s});return r.update(n=>({...n,[u.local_id]:u})),u}}async function T(e,i,t){var c;const o=await A(e);if(o){const s=await B(i);if(s){const u=(c=h())==null?void 0:c.id;let n={};f()&&(n=await p.patchApiQuestionsId({quizId:o.id,id:s.id,patchApiQuestionsId:t}));const d=await L(u,o.local_id,o.id,i,{...s,...n});return r.update(w=>({...w,[d.local_id]:d})),d}}}async function W(e,i){var o;const t=await A(e);if(t){const c=(o=h())==null?void 0:o.id;if(f()){const s=await B(i);s&&(await p.deleteApiQuestionsId({quizId:t.id,id:s.id}),await y(i))}else await F(c,t.local_id,t.id,i);r.update(s=>(s={...s},delete s[i],s))}}async function D(e){const i=await U(),t=Object.values(i).reduce((n,d)=>(n[d.id]=d,n),{}),o=await k(e),c={},s={},u=[];for(const n of o)n.id===0?u.push(n):s[n.id]=n,n.local_deleted===0&&(c[n.local_id]=n);if(r.update(n=>({...n,...c})),f()){const n=(await Promise.all(Object.keys(t).map(a=>p.getApiQuestions({quizId:parseInt(a)})))).flat(1),d={},w=new Set,b=[];for(const a of n){const l=s[a.id];if(l)l.updated_at>a.updated_at?l.local_deleted===1?b.push(p.deleteApiQuestionsId({quizId:a.learnable_resource_id,id:a.id}).then(()=>y(l.local_id)).then(()=>{w.add(l.local_id)})):b.push(p.patchApiQuestionsId({quizId:a.learnable_resource_id,id:a.id,patchApiQuestionsId:{...a,...l}}).then(_=>{d[l.id]={...l,..._}})):l.updated_at<a.updated_at?b.push(L(e,l.local_learnable_resource,a.learnable_resource_id,l.local_id,{...l,...a}).then(_=>{d[_.local_id]=_})):d[l.local_id]={...l,...a};else{const _=t[a.learnable_resource_id];b.push(v(e,_.local_id,_.id,a).then(I=>{d[I.local_id]=I}))}}for(const a of u)b.push(p.postApiQuestions({quizId:a.learnable_resource_id,postApiQuestions:a}).then(l=>x(e,a.local_learnable_resource,a.learnable_resource_id,a.local_id,l)).then(l=>{d[l.local_id]=l}));await Promise.all(b),await Promise.all(Object.values(s).map(async a=>{d[a.local_id]||(w.add(a.local_id),await y(a.local_id))})),r.update(a=>{a={...a,...d};for(const l of w)delete a[l];return a})}}j.on("online",async()=>{const e=await z();D(e.id)});z().then(e=>D(e.id));export{C as a,R as c,W as d,M as q,T as u};
