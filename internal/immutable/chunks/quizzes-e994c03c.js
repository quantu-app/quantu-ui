import{d as R,w as U}from"./index-779a6bb2.js";import{E as T,o as G,w as v,a as _,q as p,g}from"./user-2e20fb31.js";import{A as K,a1 as O}from"./index-169c4bf0.js";function we(){return Math.random().toString(36).substring(2)}function j(e){return e.trim().replace(/\s+/g,"-").replace(/[^a-z0-9-_]/gi,"").toLowerCase()}function me(e){K().then(()=>e.focus())}const X=(e,t)=>t.some(n=>e instanceof n);let S,L;function $(){return S||(S=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function H(){return L||(L=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const N=new WeakMap,b=new WeakMap,x=new WeakMap,y=new WeakMap,q=new WeakMap;function J(e){const t=new Promise((n,i)=>{const s=()=>{e.removeEventListener("success",o),e.removeEventListener("error",r)},o=()=>{n(l(e.result)),s()},r=()=>{i(e.error),s()};e.addEventListener("success",o),e.addEventListener("error",r)});return t.then(n=>{n instanceof IDBCursor&&N.set(n,e)}).catch(()=>{}),q.set(t,e),t}function Y(e){if(b.has(e))return;const t=new Promise((n,i)=>{const s=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",r),e.removeEventListener("abort",r)},o=()=>{n(),s()},r=()=>{i(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",o),e.addEventListener("error",r),e.addEventListener("abort",r)});b.set(e,t)}let E={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return b.get(e);if(t==="objectStoreNames")return e.objectStoreNames||x.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return l(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Z(e){E=e(E)}function ee(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const i=e.call(D(this),t,...n);return x.set(i,t.sort?t.sort():[t]),l(i)}:H().includes(e)?function(...t){return e.apply(D(this),t),l(N.get(this))}:function(...t){return l(e.apply(D(this),t))}}function te(e){return typeof e=="function"?ee(e):(e instanceof IDBTransaction&&Y(e),X(e,$())?new Proxy(e,E):e)}function l(e){if(e instanceof IDBRequest)return J(e);if(y.has(e))return y.get(e);const t=te(e);return t!==e&&(y.set(e,t),q.set(t,e)),t}const D=e=>q.get(e);function ne(e,t,{blocked:n,upgrade:i,blocking:s,terminated:o}={}){const r=indexedDB.open(e,t),d=l(r);return i&&r.addEventListener("upgradeneeded",u=>{i(l(r.result),u.oldVersion,u.newVersion,l(r.transaction),u)}),n&&r.addEventListener("blocked",u=>n(u.oldVersion,u.newVersion,u)),d.then(u=>{o&&u.addEventListener("close",()=>o()),s&&u.addEventListener("versionchange",a=>s(a.oldVersion,a.newVersion,a))}).catch(()=>{}),d}const ie=["get","getKey","getAll","getAllKeys","count"],oe=["put","add","delete","clear"],Q=new Map;function M(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(Q.get(t))return Q.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,s=oe.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(s||ie.includes(n)))return;const o=async function(r,...d){const u=this.transaction(r,s?"readwrite":"readonly");let a=u.store;return i&&(a=a.index(d.shift())),(await Promise.all([a[n](...d),s&&u.done]))[0]};return Q.set(t,o),o}Z(e=>({...e,get:(t,n,i)=>M(t,n)||e.get(t,n,i),has:(t,n)=>!!M(t,n)||e.has(t,n)}));const se="quantu",ae=1,re={upgrade(e,t,n){n===1&&(e.createObjectStore("quizzes",{keyPath:"local_id",autoIncrement:!0}).createIndex("user_id","user_id"),e.createObjectStore("questions",{keyPath:"local_id",autoIncrement:!0}).createIndex("user_id","user_id"))}};function w(){return ce(se,ae,re)}let m,I=!1;const P=new T;function ce(e,t,n={}){return m?Promise.resolve(m):I?new Promise(i=>P.once("db",i)):(I=!0,ne(e,t,n).then(i=>(i.addEventListener("close",()=>{m=void 0}),m=i,P.emit("db",i),i)).finally(()=>{I=!1}))}async function ue(e){return await(await w()).getAllFromIndex("quizzes","user_id",e)}async function C(e){return await(await w()).get("quizzes",e)}async function V(e,t){const n=await w(),i={...h(e),...t,uri:j(t.name)},s=await n.put("quizzes",i);return{...i,local_id:s}}async function k(e,t,n){const i=await w(),s=await i.get("quizzes",t)||h(e),o={...s,...n,user_id:e,local_id:t,uri:n.name?j(n.name):s.uri,updated_at:new Date};return await i.put("quizzes",o),o}async function de(e,t,n){const i=await w(),o={...await i.get("quizzes",t)||h(e),...n,user_id:e,local_id:t};return await i.put("quizzes",o),o}async function le(e,t){const n=await w(),s={...await n.get("quizzes",t)||h(e),local_id:t,updated_at:new Date,local_deleted:1};await n.put("quizzes",s)}async function B(e){await(await w()).delete("quizzes",e)}function h(e){return{id:0,local_deleted:0,user_id:e,name:"",uri:"",created_at:new Date,updated_at:new Date}}const z=U({}),_e=R(z,e=>Object.values(e));async function he(e){var s;const t=(s=g())==null?void 0:s.id;let n={};_()&&(n=await p.postApiQuizzes({postApiQuizzes:e}));const i=await V(t,{...e,...n});return z.update(o=>({...o,[i.local_id]:i})),i}async function ye(e,t){var s;const n=(s=g())==null?void 0:s.id,i=await C(e);if(i){let o={};_()&&(o=await p.patchApiQuizzesId({id:i.id,patchApiQuizzesId:t}));const r=await k(n,e,{...i,...o});return z.update(d=>({...d,[r.local_id]:r})),r}}async function De(e){var n;const t=(n=g())==null?void 0:n.id;if(_()){const i=await C(e);i&&(await p.deleteApiQuizzesId({id:i.id}),await B(e))}else await le(t,e);z.update(i=>(i={...i},delete i[e],i))}function Qe(){return A?new Promise(e=>F.once("quizzes",e)):Promise.resolve(O(z))}const F=new T;let A=!1;async function W(e){A=!0;try{const t=await ue(e),n={},i={},s=[];for(const o of t)o.id===0?s.push(o):i[o.id]=o,o.local_deleted===0&&(n[o.local_id]=o);if(z.update(o=>({...o,...n})),_()){const o=await p.getApiQuizzes(),r={},d=new Set,u=[];for(const a of o){const c=i[a.id];c?c.updated_at>a.updated_at?c.local_deleted===1?u.push(p.deleteApiQuizzesId({id:a.id}).then(()=>B(c.local_id)).then(()=>{d.add(c.local_id)})):u.push(p.patchApiQuizzesId({id:a.id,patchApiQuizzesId:{...a,...c}}).then(f=>{r[c.id]={...c,...f}})):c.updated_at<a.updated_at?u.push(k(e,c.local_id,{...c,...a}).then(f=>{r[f.local_id]=f})):r[c.local_id]={...c,...a}:u.push(V(e,a).then(f=>{r[f.local_id]=f}))}for(const a of s)u.push(p.postApiQuizzes({postApiQuizzes:a}).then(c=>de(e,a.local_id,c)).then(c=>{r[c.local_id]=c}));await Promise.all(u),await Promise.all(Object.values(i).map(async a=>{r[a.local_id]||(d.add(a.local_id),await B(a.local_id))})),z.update(a=>{a={...a,...r};for(const c of d)delete a[c];return a})}}finally{A=!1,F.emit("quizzes",O(z))}}G.on("online",async()=>{const e=await v();W(e.id)});v().then(e=>W(e.id));export{me as a,we as b,he as c,De as d,j as e,Qe as f,w as g,C as i,_e as q,ye as u};
