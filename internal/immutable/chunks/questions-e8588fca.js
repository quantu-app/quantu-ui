import{d as m,w as B}from"./index-779a6bb2.js";import{o as v,w as y,a as h,q as z,g as O,b as j}from"./user-2e20fb31.js";import{g as Q,d as I,e as D,i as L}from"./quizzes-97fcea80.js";async function U(t){return await(await Q()).getAllFromIndex("questions","user_id",t)}async function A(t,a,e,n){const d=await Q(),u={...f(t,a,e),...n,uri:n.name?I(n.name):void 0},l=await d.put("questions",u);return{...u,local_id:l}}async function x(t,a,e,n,d){const u=await Q(),l=await u.get("questions",n)||f(t,a,e),s={...l,...d,user_id:t,local_quiz_id:a,quiz_id:e,local_id:n,uri:d.name?I(d.name):l.uri,updated_at:new Date};return await u.put("questions",s,n),s}async function F(t,a,e,n,d){const u=await Q(),s={...await u.get("questions",n)||f(t,a,e),...d,user_id:t,local_quiz_id:a,quiz_id:e,local_id:n};return await u.put("questions",s),s}async function b(t){await(await Q()).delete("questions",t)}function f(t,a,e){return{id:0,local_quiz_id:a,local_deleted:0,quiz_id:e,user_id:t,name:"",uri:"",created_at:new Date,updated_at:new Date}}const p=B({});m(p,t=>Object.values(t));const E=m(p,t=>Object.values(t).reduce((a,e)=>((a[e.local_quiz_id]||(a[e.local_quiz_id]=[])).push(e),a),{}));async function G(t,a){var n;const e=await L(t);if(e){const d=(n=O())==null?void 0:n.id;let u={};h()&&(u=await j.postApiQuestions({quizId:e.id,postApiQuestions:a}));const l=await A(d,e.local_id,e.id,{...a,...u});return p.update(s=>({...s,[l.local_id]:l})),l}}async function g(t){const a=await D(),e=Object.values(a).reduce((s,c)=>(s[c.id]=c,s),{}),n=await U(t),d={},u={},l=[];for(const s of n)s.id===0?l.push(s):u[s.id]=s,s.local_deleted===0&&(d[s.local_id]=s);if(p.update(s=>({...s,...d})),h()){const s=(await Promise.all(Object.keys(e).map(i=>z.getApiQuizzesQuizIdQuestions({quizId:parseInt(i)})))).flat(1),c={},q=new Set,_=[];for(const i of s){const o=u[i.id];if(o)o.updated_at>i.updated_at?o.local_deleted===1?_.push(z.deleteApiQuizzesQuizIdQuestionsId({quizId:i.quiz_id,id:i.id}).then(()=>b(o.local_id)).then(()=>{q.add(o.local_id)})):_.push(z.patchApiQuizzesQuizIdQuestionsId({quizId:i.quiz_id,id:i.id,patchApiQuizzesQuizIdQuestionsId:{...i,...o}}).then(r=>{c[o.id]={...o,...r}})):o.updated_at<i.updated_at?_.push(x(t,o.local_quiz_id,i.quiz_id,o.local_id,{...o,...i}).then(r=>{c[r.local_id]=r})):c[o.local_id]={...o,...i};else{const r=e[i.quiz_id];_.push(A(t,r.local_id,r.id,i).then(w=>{c[w.local_id]=w}))}}for(const i of l)_.push(z.postApiQuizzesQuizIdQuestions({quizId:i.quiz_id,postApiQuizzesQuizIdQuestions:i}).then(o=>F(t,i.local_quiz_id,i.quiz_id,i.local_id,o)).then(o=>{c[o.local_id]=o}));await Promise.all(_),await Promise.all(Object.values(u).map(async i=>{c[i.local_id]||(q.add(i.local_id),await b(i.local_id))})),p.update(i=>{i={...i,...c};for(const o of q)delete i[o];return i})}}v.on("online",async()=>{const t=await y();g(t.id)});y().then(t=>g(t.id));export{G as c,E as q};
